#!/bin/bash

# Define a rede base onde será feito o scan
ip="172.16.1.0"

# Define a sequência de portas usada no Port Knocking
portas=(13 37 30000 3000)


apres()
{
        clear
        echo -e "\033[01;31m"

        # Banner ASCII
        echo "
  _____      _               _____                      _ _          ___   ___   ___   ___  
 / ____|    | |             / ____|                    (_) |        / _ \ / _ \ / _ \ / _ \ 
| |    _   _| |__   ___ _ _| (___   ___  ___ _   _ _ __ _| |_ _   _| | | | | | | | | | | | |
| |   | | | | '_ \ / _ \ '__\___ \ / _ \/ __| | | | '__| | __| | | | | | | | | | | | | | | |
| |___| |_| | |_) |  __/ |  ____) |  __/ (__| |_| | |  | | |_| |_| | |_| | |_| | |_| | |_| |
 \_____\__, |_.__/ \___|_| |_____/ \___|\___|\__,_|_|  |_|\__|\__, |\___/ \___/ \___/ \___/ 
        __/ |                                                  __/ |                        
       |___/                                                  |___/                 
       
       Port Knocking - Internal NetWorking"

        echo -e "\033[00;00m"
}

buscando()
{
        echo -e "\033[01;32m"
        echo -e "###########################################"
        echo -e "|->          Ativando Portas..          <-|"
        echo -e "###########################################"
        echo -e "\033[00;00m"
}

ping_sweep()
{
       	echo -e "\033[01;33m"
        echo -e "###########################################"
        echo -e "|->          Ping Sweep ...             <-|"
        echo -e "###########################################"
        echo -e "\033[00;00m"
	
	# Realiza um scan ICMP na rede /24
	nmap -sn $ip/24 > list.txt

	# Filtra apenas as linhas com "for" (onde o Nmap mostra o IP ativo)  e pega só a 5ª coluna (que é o IP)
	cat list.txt | grep "for" | cut -d " " -f 5 > lista_ip.txt
}

knock_internal()
{
	buscando

	# Loop por cada IP ativo encontrado
	for i in $(cat lista_ip.txt)
	do
		echo "# Testando IP -> $i"

		# Para cada IP, envia a sequência de Port Knocking
		for j in ${portas[@]}
		do
			# hping envia 1 pacote SYN para cada porta
			hping3 -c 1 -S -p $j $i 1>/dev/null 2>&1
			echo "# Enviando pacote Syn na porta $j"	
		done

		# Tenta acessar a porta 1337 após o knocking timeout 3s, tenta 1 vez só
		echo ""
		cmd=$(wget -q --no-verbose --timeout=3 --tries=1 $i:1337 2>/dev/null)

		# Verifica se o wget teve sucesso
		if [ $? -eq 0 ]
		then
			echo -e "\n--------------------------------------------------------------------------------------------------"
			
			# Mostra a página, removendo <br> e <hr> para ficar mais limpo
			cat index.html 2>/dev/null | grep -Ev "<br>|<hr>"

			echo -e "--------------------------------------------------------------------------------------------------\n"
		fi

		# Remove qualquer index salvo, para não acumular
		rm index.html 2>/dev/null
	done

	# Remove a lista temporária após terminar
	rm lista_ip.txt 2>/dev/null
}

# Mostra banner
apres

# Primeiro: descobre hosts ativos
ping_sweep

# Depois: faz port knocking em cada host ativo
knock_internal

